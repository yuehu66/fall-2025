--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\rans0001\Dropbox\GitHubReposTeaching\phd-metrics-fall-2025\In-classCoding\RCR\demo_uncorrelated.log
  log type:  text
 opened on:  19 Nov 2025, 09:59:30

. set seed 12345

. set obs 100000
Number of observations (_N) was 0, now 100,000.

. 
. * ---- True parameters ----
. scalar y_int = 2.5

. scalar alpha_true = 0.5

. scalar f_load = 0.25

. scalar unique_var = 0.5

. scalar y_noise_var = 1.0

. scalar d_noise_var = 0.1

. scalar d_load = 0.1

. scalar y_load = 0.5

. 
. * ---- Latent factor for correlation ----
. gen F = rnormal()

. 
. * ---- Generate 5 W's and 5 X's, correlated via F ----
. forvalues i=1/5 {
  2.     gen W`i' = sqrt(unique_var)*rnormal()
  3. }

. forvalues i=1/5 {
  2.     gen X`i' = f_load*F + sqrt(unique_var)*rnormal()
  3. }

. 
. * ---- Unobserved and observed factors ----
. * First-stage:
. * True d depends on both observed (X) and unobserved (W) variables
. gen u_d = sqrt(d_noise_var)*rnormal()

. gen d = d_load*X1 + d_load*X2 + d_load*X3 + d_load*X4 + d_load*X5 + ///
>         d_load*W1 + d_load*W2 + d_load*W3 + d_load*W4 + d_load*W5 + u_d

. 
. * ---- True model: y = αd + Xβ + Wγ + noise ----
. * Second-stage:
. gen u_y = sqrt(y_noise_var)*rnormal()

. gen y = y_int + alpha_true*d + ///
>         y_load*X1 + y_load*X2 + y_load*X3 + y_load*X4 + y_load*X5 + ///
>         y_load*W1 + y_load*W2 + y_load*W3 + y_load*W4 + y_load*W5 + u_y

. 
. *-------------------------------------------------------------------------------
. * Program to calibrate rho_k's
. *-------------------------------------------------------------------------------
. capture program drop calc_rho_k

. program define calc_rho_k
  1.     syntax varlist(min=2) [if] [in], Treatment(varname) [NOIsily SORT]
  2.     
.     marksample touse
  3.     
.     // Separate treatment variable from covariates
.     local covars : list varlist - treatment
  4.     
.     // Step 1: Run selection regression (Treatment on Controls)
.     if "`noisily'" != "" {
  5.         regress `treatment' `covars' if `touse'
  6.     }
  7.     else {
  8.         quietly regress `treatment' `covars' if `touse'
  9.     }
 10.     
.     // Step 2: Get full predicted index
.     tempvar full_index
 11.     quietly predict `full_index' if `touse', xb
 12.     
.     // Step 3: Store results in temporary frame or matrices
.     tempname results
 13.     matrix `results' = J(`: word count `covars'', 3, .)
 14.     matrix colnames `results' = coefficient sd_k rho_k
 15.     
.     local i = 1
 16.     foreach k of local covars {
 17.         
.         // Get coefficient for W_1k
.         local pi_k = _b[`k']
 18.         
.         // Calculate sqrt(Var(pi_k * W_1k)) - the numerator
.         tempvar index_k
 19.         quietly gen `index_k' = `pi_k' * `k' if `touse'
 20.         quietly summarize `index_k' if `touse'
 21.         local sd_k = sqrt(r(Var))
 22.         
.         // Calculate sqrt(Var(pi_-k' * W_-k)) - the denominator
.         tempvar index_minus_k
 23.         quietly gen `index_minus_k' = `full_index' - `pi_k' * `k' if `touse'
 24.         quietly summarize `index_minus_k' if `touse'
 25.         local sd_minus_k = sqrt(r(Var))
 26.         
.         // Calculate rho_k
.         local rho_k = `sd_k' / `sd_minus_k'
 27.         
.         // Store in matrix
.         matrix `results'[`i', 1] = `pi_k'
 28.         matrix `results'[`i', 2] = `sd_k'
 29.         matrix `results'[`i', 3] = `rho_k'
 30.         
.         // Clean up temporary variables
.         drop `index_k' `index_minus_k'
 31.         
.         local i = `i' + 1
 32.     }
 33.     
.     // Step 4: Create dataset with results and optionally sort
.     preserve
 34.     clear
 35.     svmat `results', names(col)
 36.     gen varname = ""
 37.     local i = 1
 38.     foreach k of local covars {
 39.         replace varname = "`k'" if _n == `i'
 40.         local i = `i' + 1
 41.     }
 42.     
.     if "`sort'" != "" {
 43.         gsort -rho_k
 44.     }
 45.     
.     // Step 5: Display results
.     di ""
 46.     di as text "{hline 70}"
 47.     di as text "Rho_k Calculations: Relative Importance of Each Covariate"
 48.     if "`sort'" != "" {
 49.         di as text "(sorted by rho_k in descending order)"
 50.     }
 51.     di as text "{hline 70}"
 52.     di as text "Covariate" _col(30) "Coefficient" _col(45) "Rho_k"
 53.     di as text "{hline 70}"
 54.     
.     forvalues i = 1/`=_N' {
 55.         local k = varname[`i']
 56.         local pi_k = coefficient[`i']
 57.         local rho_k = rho_k[`i']
 58.         di as text "`k'" _col(30) as result %9.4f `pi_k' _col(45) as result %9.4f `rho_k'
 59.     }
 60.     
.     di as text "{hline 70}"
 61.     di as text "Note: Rho_k measures importance of variable k relative to all other"
 62.     di as text "      observed covariates in the selection equation."
 63.     di as text "      Compare breakdown point r_X^bp against these rho_k values."
 64.     di as text "{hline 70}"
 65.     di ""
 66.     
.     restore
 67.     
. end

. 
. 
. *-------------------------------------------------------------------------------
. * Analysis: short, medium, and long regressions and regsensitivity bounds
. *-------------------------------------------------------------------------------
. local covars X1 X2 X3 X4 X5

. * basic regressions
. regress y d       

      Source |       SS           df       MS      Number of obs   =   100,000
-------------+----------------------------------   F(1, 99998)     =  51365.44
       Model |  101927.731         1  101927.731   Prob > F        =    0.0000
    Residual |  198432.436    99,998  1.98436405   R-squared       =    0.3394
-------------+----------------------------------   Adj R-squared   =    0.3393
       Total |  300360.166    99,999   3.0036317   Root MSE        =    1.4087

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
           d |   2.467666   .0108881   226.64   0.000     2.446325    2.489006
       _cons |   2.503769   .0044546   562.06   0.000     2.495038      2.5125
------------------------------------------------------------------------------

. regress y d `covars'

      Source |       SS           df       MS      Number of obs   =   100,000
-------------+----------------------------------   F(6, 99993)     =  16725.05
       Model |  150447.906         6   25074.651   Prob > F        =    0.0000
    Residual |   149912.26    99,993  1.49922755   R-squared       =    0.5009
-------------+----------------------------------   Adj R-squared   =    0.5009
       Total |  300360.166    99,999   3.0036317   Root MSE        =    1.2244

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
           d |   1.489629   .0109147   136.48   0.000     1.468236    1.511022
          X1 |   .3932676   .0053659    73.29   0.000     .3827506    .4037847
          X2 |    .400367   .0053899    74.28   0.000     .3898029    .4109311
          X3 |   .3995301   .0053807    74.25   0.000     .3889841    .4100762
          X4 |   .4006327   .0053603    74.74   0.000     .3901267    .4111387
          X5 |   .3950013   .0053769    73.46   0.000     .3844626      .40554
       _cons |   2.501459   .0038721   646.02   0.000      2.49387    2.509049
------------------------------------------------------------------------------

. * infeasible regression
. regress y d `covars' W1-W5

      Source |       SS           df       MS      Number of obs   =   100,000
-------------+----------------------------------   F(11, 99988)    =  18149.85
       Model |  200130.622        11  18193.6929   Prob > F        =    0.0000
    Residual |  100229.544    99,988  1.00241573   R-squared       =    0.6663
-------------+----------------------------------   Adj R-squared   =    0.6663
       Total |  300360.166    99,999   3.0036317   Root MSE        =    1.0012

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
           d |   .4986547   .0099734    50.00   0.000      .479107    .5182024
          X1 |   .4940187   .0044109   112.00   0.000     .4853733     .502664
          X2 |   .5023218   .0044312   113.36   0.000     .4936367    .5110069
          X3 |   .4970385   .0044215   112.41   0.000     .4883723    .5057046
          X4 |   .5003261   .0044059   113.56   0.000     .4916907    .5089615
          X5 |   .4998311    .004422   113.03   0.000     .4911639    .5084982
          W1 |   .4928114   .0045737   107.75   0.000     .4838471    .5017758
          W2 |   .4986039   .0045945   108.52   0.000     .4895988    .5076091
          W3 |   .5039653     .00459   109.80   0.000      .494969    .5129617
          W4 |   .5050599   .0045926   109.97   0.000     .4960584    .5140613
          W5 |   .5004155   .0046125   108.49   0.000     .4913751     .509456
       _cons |   2.499627   .0031663   789.45   0.000     2.493421    2.505833
------------------------------------------------------------------------------

. 
. * calibrating rho_k's
. reg d `covars'

      Source |       SS           df       MS      Number of obs   =   100,000
-------------+----------------------------------   F(5, 99994)     =   6601.20
       Model |  4153.94864         5  830.789729   Prob > F        =    0.0000
    Residual |  12584.6711    99,994  .125854262   R-squared       =    0.2482
-------------+----------------------------------   Adj R-squared   =    0.2481
       Total |  16738.6197    99,999  .167387871   Root MSE        =    .35476

------------------------------------------------------------------------------
           d | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          X1 |   .1016328   .0015211    66.82   0.000     .0986515    .1046142
          X2 |   .0998264   .0015294    65.27   0.000     .0968289     .102824
          X3 |   .1014288   .0015256    66.48   0.000     .0984386     .104419
          X4 |   .0993819   .0015209    65.34   0.000      .096401    .1023629
          X5 |   .1023102   .0015239    67.14   0.000     .0993233     .105297
       _cons |  -.0005085   .0011219    -0.45   0.650    -.0027073    .0016904
------------------------------------------------------------------------------

. calc_rho_k d `covars', t(d) noisily sort

      Source |       SS           df       MS      Number of obs   =   100,000
-------------+----------------------------------   F(5, 99994)     =   6601.20
       Model |  4153.94864         5  830.789729   Prob > F        =    0.0000
    Residual |  12584.6711    99,994  .125854262   R-squared       =    0.2482
-------------+----------------------------------   Adj R-squared   =    0.2481
       Total |  16738.6197    99,999  .167387871   Root MSE        =    .35476

------------------------------------------------------------------------------
           d | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          X1 |   .1016328   .0015211    66.82   0.000     .0986515    .1046142
          X2 |   .0998264   .0015294    65.27   0.000     .0968289     .102824
          X3 |   .1014288   .0015256    66.48   0.000     .0984386     .104419
          X4 |   .0993819   .0015209    65.34   0.000      .096401    .1023629
          X5 |   .1023102   .0015239    67.14   0.000     .0993233     .105297
       _cons |  -.0005085   .0011219    -0.45   0.650    -.0027073    .0016904
------------------------------------------------------------------------------
number of observations will be reset to 5
Press any key to continue, or Break to abort
Number of observations (_N) was 0, now 5.
(5 missing values generated)
variable varname was str1 now str2
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)

----------------------------------------------------------------------
Rho_k Calculations: Relative Importance of Each Covariate
(sorted by rho_k in descending order)
----------------------------------------------------------------------
Covariate                    Coefficient    Rho_k
----------------------------------------------------------------------
X5                              0.1023         0.4398
X1                              0.1016         0.4375
X3                              0.1014         0.4341
X4                              0.0994         0.4259
X2                              0.0998         0.4251
----------------------------------------------------------------------
Note: Rho_k measures importance of variable k relative to all other
      observed covariates in the selection equation.
      Compare breakdown point r_X^bp against these rho_k values.
----------------------------------------------------------------------


. 
. * regsensitivity
. regsensitivity breakdown y d `covars', compare(`covars')

Regression Sensitivity Analysis, Breakdown Frontier

Analysis         : DMP (2022)                  Number of obs      =     100,000
                                               Beta(short)        =       2.468
Treatment        : d                           Beta(medium)       =       1.490
Outcome          : y                           R2(short)          =       0.339
                                               R2(medium)         =       0.501
                                               Var(Y)             =       3.004
                                               Var(X)             =       0.167
Hypothesis       : Beta > 0                    Var(X_Residual)    =       0.126

--------------------------------------------------------------------------------
 cbar                               rxbar(Breakdown)
--------------------------------------------------------------------------------
 1.000                              56.8 %
--------------------------------------------------------------------------------

. regsensitivity breakdown y d `covars', compare(`covars') cbar(0(.1)1)

Regression Sensitivity Analysis, Breakdown Frontier

Analysis         : DMP (2022)                  Number of obs      =     100,000
                                               Beta(short)        =       2.468
Treatment        : d                           Beta(medium)       =       1.490
Outcome          : y                           R2(short)          =       0.339
                                               R2(medium)         =       0.501
                                               Var(Y)             =       3.004
                                               Var(X)             =       0.167
Hypothesis       : Beta > 0                    Var(X_Residual)    =       0.126

--------------------------------------------------------------------------------
 cbar                               rxbar(Breakdown)
--------------------------------------------------------------------------------
 0.000                              69.0 %
 0.100                              64.8 %
 0.200                              61.7 %
 0.300                              59.4 %
 0.400                              57.8 %
 0.500                              57.0 %
 0.600                              56.8 %
 0.700                              56.8 %
 0.800                              56.8 %
 0.900                              56.8 %
 1.000                              56.8 %
--------------------------------------------------------------------------------

. //regsensitivity breakdown y d `covars', compare(`covars') rybar(=rxbar) cbar(0(.1)1)
. //regsensitivity breakdown y d `covars', compare(`covars') rybar(=rxbar) cbar(0(.1)1) beta(0.5)
. regsensitivity breakdown y d `covars', compare(`covars') rybar(=rxbar) cbar(0) beta(0.5)

Regression Sensitivity Analysis, Breakdown Frontier

Analysis         : DMP (2022)                  Number of obs      =     100,000
                                               Beta(short)        =       2.468
Treatment        : d                           Beta(medium)       =       1.490
Outcome          : y                           R2(short)          =       0.339
                                               R2(medium)         =       0.501
                                               Var(Y)             =       3.004
                                               Var(X)             =       0.167
Hypothesis       : Beta > .5                   Var(X_Residual)    =       0.126
Other Params     : rybar = rxbar
--------------------------------------------------------------------------------
 cbar                               rxbar(Breakdown)
--------------------------------------------------------------------------------
 0.000                              100.8%
--------------------------------------------------------------------------------

. //regsensitivity plot
. regsensitivity bounds    y d `covars', compare(`covars') rybar(=rxbar) cbar(1)

Regression Sensitivity Analysis, Bounds

Analysis         : DMP (2022)                  Number of obs      =     100,000
                                               Beta(short)        =       2.468
Treatment        : d                           Beta(medium)       =       1.490
Outcome          : y                           R2(short)          =       0.339
                                               R2(medium)         =       0.501
                                               Var(Y)             =       3.004
                                               Var(X)             =       0.167
                                               Var(X_Residual)    =       0.126

Other Params     : cbar = 1

--------------------------------------------------------------------------------
 rxbar   rybar                     Beta
--------------------------------------------------------------------------------
 0.000   0.000                    [ 1.4896,  1.4896 ]
 0.087   0.087                    [ 1.4797,  1.4994 ]
 0.173   0.173                    [ 1.4489,  1.5284 ]
 0.260   0.260                    [ 1.3929,  1.5757 ]
 0.347   0.347                    [ 1.3033,  1.6402 ]
 0.434   0.434                    [ 1.1636,  1.7199 ]
 0.520   0.520                    [ 0.9394,  1.8129 ]
 0.607   0.607                    [ 0.5499,  1.9170 ]
 0.694   0.694                    [-0.2492,  2.0298 ]
 0.780   0.780                    [-2.0604,  2.1491 ]
 0.867   0.867                    [   -inf,    +inf ]
--------------------------------------------------------------------------------

. regsensitivity bounds    y d `covars', compare(`covars') rybar(=rxbar) cbar(0)

Regression Sensitivity Analysis, Bounds

Analysis         : DMP (2022)                  Number of obs      =     100,000
                                               Beta(short)        =       2.468
Treatment        : d                           Beta(medium)       =       1.490
Outcome          : y                           R2(short)          =       0.339
                                               R2(medium)         =       0.501
                                               Var(Y)             =       3.004
                                               Var(X)             =       0.167
                                               Var(X_Residual)    =       0.126

Other Params     : cbar = 0

--------------------------------------------------------------------------------
 rxbar   rybar                     Beta
--------------------------------------------------------------------------------
 0.000   0.000                    [           1,            1 ]
 0.216   0.216                    [           1,            2 ]
 0.431   0.431                    [           1,            2 ]
 0.647   0.647                    [           1,            2 ]
 0.862   0.862                    [           1,            3 ]
 1.078   1.078                    [           0,            4 ]
 1.293   1.293                    [           0,            5 ]
 1.509   1.509                    [          -0,            7 ]
 1.725   1.725                    [          -0,           27 ]
 1.940   1.940                    [-232,405,086,  232,405,089 ]
 2.156   2.156                    [        -inf,         +inf ]
--------------------------------------------------------------------------------

. regsensitivity bounds    y d `covars', compare(`covars')

Regression Sensitivity Analysis, Bounds

Analysis         : DMP (2022)                  Number of obs      =     100,000
                                               Beta(short)        =       2.468
Treatment        : d                           Beta(medium)       =       1.490
Outcome          : y                           R2(short)          =       0.339
                                               R2(medium)         =       0.501
                                               Var(Y)             =       3.004
                                               Var(X)             =       0.167
                                               Var(X_Residual)    =       0.126

Hypothesis       : Beta > 0                    Breakdown Point    =        56.8%
Other Params     : rybar = +inf, cbar = 1

--------------------------------------------------------------------------------
 rxbar                             Beta
--------------------------------------------------------------------------------
 0.000                            [ 1.4896,  1.4896 ]
 0.087                            [ 1.3168,  1.6624 ]
 0.173                            [ 1.1387,  1.8406 ]
 0.260                            [ 0.9489,  2.0303 ]
 0.347                            [ 0.7392,  2.2400 ]
 0.434                            [ 0.4970,  2.4823 ]
 0.520                            [ 0.2001,  2.7792 ]
 0.607                            [-0.1957,  3.1749 ]
 0.694                            [-0.8029,  3.7821 ]
 0.780                            [-2.0604,  5.0397 ]
 0.867                            [   -inf,    +inf ]
--------------------------------------------------------------------------------

. //regsensitivity plot
. 
. log close
      name:  <unnamed>
       log:  C:\Users\rans0001\Dropbox\GitHubReposTeaching\phd-metrics-fall-2025\In-classCoding\RCR\demo_uncorrelated.log
  log type:  text
 closed on:  19 Nov 2025, 09:59:36
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
